---
import IconArrowNarrowUp from "@assets/icons/IconArrowNarrowUp.svg";
---

<div
  id="btt-btn-container"
  class:list={[
    "fixed right-4 bottom-8 z-50",
    "md:sticky md:right-auto md:float-end md:mr-1",
    "translate-y-14 opacity-0 transition duration-500",
  ]}
>
  <button
    type="button"
    data-button="back-to-top"
    aria-label="Back to top"
    title="Back to top"
    class:list={[
      "group relative bg-background px-2 py-1",
      "size-14 rounded-full shadow-xl",
      "transition-colors duration-200",
      "focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent/60",
      "hover:bg-accent/10 hover:shadow-lg",
      "md:h-8 md:w-fit md:rounded-md md:shadow-none",
      "md:bg-background/35 md:bg-clip-padding md:backdrop-blur-lg",
    ]}
  >
    <span
      id="progress-indicator"
      aria-hidden="true"
      class="absolute inset-0 -z-10 block size-14 scale-110 rounded-full bg-transparent transition-[background-image,opacity] duration-300 ease-out md:hidden md:h-8 md:rounded-md"
    ></span>
    <span class="flex items-center justify-center md:hidden">
      <IconArrowNarrowUp
        class="size-5 transition-transform duration-200 group-hover:-translate-y-1"
        aria-hidden="true"
      />
    </span>
    <span class="sr-only text-sm group-hover:text-accent md:not-sr-only md:flex md:items-center md:gap-2">
      <IconArrowNarrowUp class="inline-block size-4" aria-hidden="true" />
      Back To Top
    </span>
  </button>
</div>

<script is:inline data-astro-rerun>
  /** Scrolls the document to the top when
   * the "Back to Top" button is clicked. */
  function backToTop() {
    const rootElement = document.documentElement;
    const scrollElement = document.scrollingElement || rootElement;
    const btnContainer = document.querySelector("#btt-btn-container");
    const backToTopBtn = document.querySelector("[data-button='back-to-top']");
    const progressIndicator = document.querySelector("#progress-indicator");

    if (!rootElement || !btnContainer || !backToTopBtn || !progressIndicator)
      return;

    const prefersReducedMotion = window.matchMedia(
      "(prefers-reduced-motion: reduce)"
    );

    // Attach click event handler for back-to-top button
    backToTopBtn.addEventListener("click", (event) => {
      event.preventDefault();
      const behavior = prefersReducedMotion.matches ? "auto" : "smooth";

      if ("scrollTo" in window) {
        window.scrollTo({ top: 0, behavior });
      } else {
        document.body.scrollTop = 0; // Safari fallback
        rootElement.scrollTop = 0;
        scrollElement.scrollTop = 0;
      }
    });

    // Handle button visibility according to scroll position
    let lastVisible = null;
    function handleScroll() {
      const scrollTotal =
        scrollElement.scrollHeight - scrollElement.clientHeight;
      const scrollTop = scrollElement.scrollTop;

      if (scrollTotal <= 0) {
        btnContainer.classList.add("opacity-0", "translate-y-14");
        btnContainer.classList.remove("opacity-100", "translate-y-0");
        progressIndicator.style.removeProperty("background-image");
        progressIndicator.style.removeProperty("opacity");
        lastVisible = false;
        return;
      }

      const scrollPercent = Math.round((scrollTop / scrollTotal) * 100);

      progressIndicator.style.setProperty(
        "background-image",
        `conic-gradient(var(--accent), var(--accent) ${scrollPercent}%, transparent ${scrollPercent}%)`
      );
      progressIndicator.style.setProperty(
        "opacity",
        scrollPercent > 0 ? "1" : "0"
      );

      const isVisible = scrollTop / scrollTotal > 0.25;

      if (isVisible !== lastVisible) {
        btnContainer.classList.toggle("opacity-100", isVisible);
        btnContainer.classList.toggle("translate-y-0", isVisible);
        btnContainer.classList.toggle("opacity-0", !isVisible);
        btnContainer.classList.toggle("translate-y-14", !isVisible);
        lastVisible = isVisible;
      }
    }

    let ticking = false;
    function onScroll() {
      if (ticking) return;
      ticking = true;
      window.requestAnimationFrame(() => {
        handleScroll();
        ticking = false;
      });
    }

    document.addEventListener("scroll", onScroll, { passive: true });
    handleScroll();

    const onMotionPreferenceChange = (event) => {
      if (!event.matches) return;
      // Reset to avoid a stuck gradient when motion gets disabled mid-session
      progressIndicator.style.removeProperty("background-image");
    };

    if (typeof prefersReducedMotion.addEventListener === "function") {
      prefersReducedMotion.addEventListener("change", onMotionPreferenceChange);
    } else if (typeof prefersReducedMotion.addListener === "function") {
      prefersReducedMotion.addListener(onMotionPreferenceChange);
    }
  }
  backToTop();
</script>
